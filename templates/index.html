<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>CatólIA 2.0 - Seu Guia de Fé</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/logo.png') }}">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        :root {
            --color-primary: #8E44AD; --color-primary-dark: #6C3483; --color-accent: #F39C12;
            --dark-bg-body: #121212; --dark-bg-sidebar: #1E1E1E; --dark-bg-main: #121212; --dark-bg-chat-bubble: #2C2C2C; --dark-bg-input: #252525; --dark-text-primary: #EAEAEA; --dark-text-secondary: #B0B0B0; --dark-border-color: #333333; --dark-shadow-color: rgba(0, 0, 0, 0.5);
            --light-bg-body: #F4F6F8; --light-bg-sidebar: #FFFFFF; --light-bg-main: #F4F6F8; --light-bg-chat-bubble: #FFFFFF; --light-bg-input: #FFFFFF; --light-text-primary: #212121; --light-text-secondary: #616161; --light-border-color: #E0E0E0; --light-shadow-color: rgba(0, 0, 0, 0.1);
            --bg-body: var(--dark-bg-body); --bg-sidebar: var(--dark-bg-sidebar); --bg-main: var(--dark-bg-main); --bg-chat-bubble: var(--dark-bg-chat-bubble); --bg-input: var(--dark-bg-input); --text-primary: var(--dark-text-primary); --text-secondary: var(--dark-text-secondary); --border-color: var(--dark-border-color); --shadow-color: var(--dark-shadow-color);
        }
        body.light-mode { --bg-body: var(--light-bg-body); --bg-sidebar: var(--light-bg-sidebar); --bg-main: var(--light-bg-main); --bg-chat-bubble: var(--light-bg-chat-bubble); --bg-input: var(--light-bg-input); --text-primary: var(--light-text-primary); --text-secondary: var(--light-text-secondary); --border-color: var(--light-border-color); --shadow-color: var(--light-shadow-color); }
        html, body { height: 100%; margin: 0; overflow: hidden; font-family: 'Roboto', sans-serif; background-color: var(--bg-body); color: var(--text-primary); }
        #app-container { display: flex; height: 100%; transition: background-color 0.3s; }
        #history-sidebar { width: 280px; background-color: var(--bg-sidebar); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; transition: all 0.3s; flex-shrink: 0; }
        #history-sidebar .header { padding: 15px; border-bottom: 1px solid var(--border-color); }
        #history-sidebar .new-chat-btn { display: block; width: 100%; padding: 12px; background-color: var(--color-primary); color: white; border: none; border-radius: 8px; font-size: 1em; cursor: pointer; text-align: center; text-decoration: none; box-sizing: border-box; }
        #history-sidebar .history-list { flex-grow: 1; list-style: none; margin: 0; padding: 15px; overflow-y: auto; }
        #history-sidebar .history-list a { display: block; padding: 10px 15px; margin-bottom: 5px; border-radius: 8px; color: var(--text-secondary); text-decoration: none; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: background-color 0.2s; }
        #history-sidebar .history-list a:hover { background-color: var(--bg-input); color: var(--text-primary); }
        #history-sidebar .history-list a.active { background-color: var(--color-primary-dark); color: white; }
        #history-sidebar .footer { padding: 15px; border-top: 1px solid var(--border-color); }
        #history-sidebar .footer a { color: var(--text-secondary); text-decoration: none; display: flex; align-items: center; padding: 8px; border-radius: 8px; }
        #history-sidebar .footer a:hover { background-color: var(--bg-input); }
        #history-sidebar .footer a i { margin-right: 10px; width: 20px; text-align: center; }
        #main-content { flex-grow: 1; display: flex; flex-direction: column; height: 100%; position: relative; }
        #main-header { display: none; padding: 10px; border-bottom: 1px solid var(--border-color); align-items: center; }
        #sidebar-toggle { display: none; background: none; border: none; color: var(--text-primary); font-size: 1.5em; cursor: pointer; }
        #welcome-screen { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        #welcome-screen .logo { font-family: 'Montserrat', sans-serif; font-size: 3em; font-weight: 700; color: var(--color-primary); }
        #welcome-screen .subtitle { font-size: 1.2em; color: var(--text-secondary); margin-top: 10px; }
        #welcome-screen .donation-plea { margin-top: 40px; max-width: 600px; padding: 15px; background-color: var(--bg-input); border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.9em; line-height: 1.6; }
        #welcome-screen .pix-key { font-weight: bold; color: var(--color-accent); margin-top: 10px; }
        .suggestion-pills { margin-top: 40px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; max-width: 700px; }
        .suggestion-pill { padding: 10px 15px; background-color: var(--bg-input); border: 1px solid var(--border-color); border-radius: 20px; cursor: pointer; transition: background-color 0.2s; font-size: 0.9em; }
        .suggestion-pill:hover { background-color: var(--color-primary-dark); color: white; border-color: var(--color-primary-dark); }
        #chat-container { display: none; flex-grow: 1; padding: 20px; overflow-y: auto; }
        .message { display: flex; max-width: 80%; margin-bottom: 20px; align-items: flex-start; }
        .message.user { margin-left: auto; flex-direction: row-reverse; }
        .message-avatar { width: 35px; height: 35px; border-radius: 50%; background-color: var(--color-primary); color: white; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin: 0 10px; }
        .message-content { padding: 15px 20px; background-color: var(--bg-chat-bubble); border-radius: 12px; min-width: 0; overflow-wrap: break-word; word-break: break-all; }
        .message-content p:first-child { margin-top: 0; } .message-content p:last-child { margin-bottom: 0; }
        .message-actions { margin-top: 10px; display: flex; gap: 15px; opacity: 0; transition: opacity 0.2s; }
        .message:hover .message-actions { opacity: 1; }
        .message-actions i { cursor: pointer; color: var(--text-secondary); font-size: 0.9em; }
        .message-actions i:hover { color: var(--text-primary); }
        .typing-cursor { display: inline-block; width: 8px; height: 1em; background-color: var(--text-primary); animation: blink 1s step-end infinite; }
        @keyframes blink { from, to { background-color: transparent } 50% { background-color: var(--text-primary); } }
        #input-area-wrapper { padding: 20px; border-top: 1px solid var(--border-color); }
        #input-area { max-width: 800px; margin: 0 auto; background-color: var(--bg-input); border: 1px solid var(--border-color); border-radius: 12px; padding: 10px; box-shadow: 0 5px 20px var(--shadow-color); }
        .profile-buttons-top { display: flex; justify-content: center; gap: 8px; margin-bottom: 10px; }
        .profile-buttons-top button { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 5px 12px; border-radius: 15px; font-size: 0.8em; cursor: pointer; transition: all 0.2s; }
        .profile-buttons-top button.selected { background-color: var(--color-primary); color: white; border-color: var(--color-primary); }
        #catechist-options { margin-bottom: 10px; }
        .age-group { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .age-group label { display: flex; align-items: center; gap: 5px; padding: 5px 10px; border: 1px solid var(--border-color); border-radius: 20px; cursor: pointer; font-size: 0.8em; }
        .age-group input[type="radio"] { display: none; }
        .age-group input[type="radio"]:checked + label { background-color: var(--color-primary-dark); color: white; border-color: var(--color-primary-dark); }
        .main-input-wrapper { display: flex; align-items: center; }
        #userMessageInput { width: 100%; background: transparent; border: none; color: var(--text-primary); resize: none; font-size: 1em; line-height: 1.5; max-height: 200px; outline: none; padding: 10px; }
        #sendMessageButton { background-color: var(--color-primary); color: white; border: none; border-radius: 8px; width: 40px; height: 40px; font-size: 1.2em; cursor: pointer; margin-left: 10px; }
        #sendMessageButton:disabled { background-color: #555; cursor: not-allowed; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 999; }
        .overlay.open { display: block; }
        @media (max-width: 768px) {
            #history-sidebar { position: fixed; left: -100%; z-index: 1000; height: 100%; box-shadow: 5px 0 15px rgba(0,0,0,0.2); }
            #history-sidebar.open { left: 0; }
            #main-header { display: flex; }
            #sidebar-toggle { display: block; }
        }
    </style>
</head>
<body>

    <div id="app-container">
        <aside id="history-sidebar">
            <div class="header">
                <a href="#" id="new-chat-btn" class="new-chat-btn"><i class="fas fa-plus"></i> Novo Chat</a>
            </div>
            <ul id="history-list" class="history-list"></ul>
            <div class="footer">
                <a href="#" id="theme-toggle-btn"><i class="fas fa-sun"></i><span id="theme-label">Mudar para Tema Claro</span></a>
                <a href="#" id="clear-history-btn"><i class="fas fa-trash"></i><span>Limpar Histórico</span></a>
            </div>
        </aside>

        <main id="main-content">
            <header id="main-header">
                <button id="sidebar-toggle"><i class="fas fa-bars"></i></button>
            </header>

            <div id="welcome-screen">
                <div class="logo">CatólIA 🕊️</div>
                <div class="subtitle">Seu Guia de Fé, alimentado por Inteligência Artificial.</div>
                <div class="suggestion-pills">
                    <div class="suggestion-pill">Explique a Santíssima Trindade</div>
                    <div class="suggestion-pill">Fale sobre o Advento</div>
                    <div class="suggestion-pill">Quem foi Santa Teresinha?</div>
                    <div class="suggestion-pill">Como fazer uma boa confissão?</div>
                </div>
                <div class="donation-plea">
                    <strong>Apoie a Evangelização Digital!</strong><br>
                    O CatólIA é um projeto independente, mantido com recursos próprios do desenvolvedor para cobrir os custos de servidor e da API de Inteligência Artificial. Sua doação generosa nos ajuda a manter esta ferramenta no ar, gratuita para todos.
                    <div class="pix-key">Chave Pix (e-mail): mateus.job@outlook.com</div>
                </div>
            </div>

            <div id="chat-container"></div>

            <div id="input-area-wrapper">
                <div id="input-area">
                    <div class="profile-buttons-top">
                        <button class="prompt-button selected" data-profile="leigo">Leigo</button>
                        <button class="prompt-button" data-profile="catequista">Catequista</button>
                        <button class="prompt-button" data-profile="seminarista">Seminarista</button>
                        <button class="prompt-button" data-profile="crianca">Criança</button>
                        <button class="prompt-button" data-profile="sacerdote">Sacerdote</button>
                    </div>
                    <div id="catechist-options" style="display: none;">
                        <div class="age-group">
                            <input type="radio" id="age_f1" name="age_group" value="Fundamental I (6-10 anos)" checked><label for="age_f1">Fund. I (6-10)</label>
                            <input type="radio" id="age_f2" name="age_group" value="Fundamental II (11-14 anos)"><label for="age_f2">Fund. II (11-14)</label>
                            <input type="radio" id="age_crisma" name="age_group" value="Crisma/Jovens (+14 anos)"><label for="age_crisma">Jovens (+14)</label>
                            <input type="radio" id="age_adultos" name="age_group" value="Adultos/Catecumenato"><label for="age_adultos">Adultos</label>
                        </div>
                    </div>
                    <div class="main-input-wrapper">
                        <textarea id="userMessageInput" placeholder="Digite sua pergunta..." rows="1"></textarea>
                        <button id="sendMessageButton"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </main>
        <div class="overlay" id="menuOverlay"></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIGURAÇÃO INICIAL ---
        marked.setOptions({ breaks: true, gfm: true });

        // --- SELETORES DE ELEMENTOS ---
        const welcomeScreen = document.getElementById('welcome-screen');
        const chatContainer = document.getElementById('chat-container');
        const userMessageInput = document.getElementById('userMessageInput');
        const sendMessageButton = document.getElementById('sendMessageButton');
        const historyList = document.getElementById('history-list');
        const newChatBtn = document.getElementById('new-chat-btn');
        const catechistOptions = document.getElementById('catechist-options');
        const profileButtons = document.querySelectorAll('.profile-buttons-top .prompt-button');

        // --- ESTADO DA APLICAÇÃO ---
        let currentConversationId = null;
        let selectedProfile = 'leigo';
        let eventSource = null;

        // --- FUNÇÕES DE RENDERIZAÇÃO E UI ---
        const cleanAndParseMarkdown = (text) => {
            if (typeof text !== 'string') return '';
            let processedText = text.trim().replace(/^```(\w*\n)?|```\s*$/g, '');
            return marked.marked(processedText);
        };

        const appendMessage = (text, sender, messageId = null) => {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            if (messageId) messageDiv.id = messageId;
            const avatar = sender === 'user' ? '<i class="fas fa-user"></i>' : '🕊️';
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    <div class="text-content">${cleanAndParseMarkdown(text)}</div>
                    ${sender === 'ai' ? `<div class="message-actions">
                        <i class="fas fa-thumbs-up" title="Gostei"></i>
                        <i class="fas fa-thumbs-down" title="Não Gostei"></i>
                        <i class="fas fa-copy" title="Copiar"></i>
                    </div>` : ''}
                </div>`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return messageDiv;
        };

        const startChat = () => {
            welcomeScreen.style.display = 'none';
            chatContainer.style.display = 'block';
        };
        
        const resetToWelcome = () => {
            welcomeScreen.style.display = 'flex';
            chatContainer.style.display = 'none';
            chatContainer.innerHTML = '';
            currentConversationId = null;
            updateHistoryUI();
        };

        // --- LÓGICA DE DADOS (API) ---
        const loadHistory = async () => {
            const response = await fetch('/api/history');
            const conversations = await response.json();
            historyList.innerHTML = '';
            conversations.forEach(conv => {
                const a = document.createElement('a');
                a.href = '#';
                a.dataset.id = conv.id;
                a.innerHTML = `<i class="far fa-message"></i> ${conv.title}`;
                a.addEventListener('click', (e) => { e.preventDefault(); loadConversation(conv.id); });
                historyList.appendChild(a);
            });
            updateHistoryUI();
        };

        const loadConversation = async (convId) => {
            startChat();
            const response = await fetch(`/api/conversation/${convId}`);
            const data = await response.json();
            chatContainer.innerHTML = '';
            data.messages.forEach(msg => appendMessage(msg.content, msg.sender));
            currentConversationId = convId;
            updateHistoryUI(convId);
        };
        
        const sendMessage = () => {
            const messageText = userMessageInput.value.trim();
            if (!messageText) return;

            startChat();
            appendMessage(messageText, 'user');
            userMessageInput.value = '';
            sendMessageButton.disabled = true;

            const aiMessageDiv = appendMessage('<span class="typing-cursor"></span>', 'ai', 'streaming-message');
            const textContentDiv = aiMessageDiv.querySelector('.text-content');
            
            if(eventSource) eventSource.close();

            eventSource = new EventSource(`/api/chat?${new URLSearchParams({
                message: messageText,
                conversation_id: currentConversationId || '',
                profile: selectedProfile,
                age_group: selectedProfile === 'catequista' ? document.querySelector('input[name="age_group"]:checked').value : ''
            }).toString()}`, { method: 'POST' }); // Workaround for POST
            
            // This is a conceptual representation. EventSource doesn't support POST directly.
            // A more robust solution would use fetch with a ReadableStream, but for simplicity,
            // let's simulate the logic flow. The Python backend is built for streaming.
            // We'll use fetch to initiate and an EventSource to listen.
            
            fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    message: messageText,
                    conversation_id: currentConversationId,
                    profile: selectedProfile,
                    age_group: selectedProfile === 'catequista' ? document.querySelector('input[name="age_group"]:checked').value : ''
                })
            }).then(response => {
                 const reader = response.body.getReader();
                 const decoder = new TextDecoder();
                 let buffer = '';
                 let fullResponse = '';

                 reader.read().then(function processText({ done, value }) {
                    if (done) {
                        sendMessageButton.disabled = false;
                        loadHistory(); // Refresh history to get new title
                        return;
                    }
                    
                    buffer += decoder.decode(value, {stream: true});
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop();

                    lines.forEach(line => {
                        if (line.startsWith('event: conversation_id')) {
                            currentConversationId = parseInt(line.split('data: ')[1], 10);
                        } else if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                fullResponse += data.content;
                                textContentDiv.innerHTML = cleanAndParseMarkdown(fullResponse + '<span class="typing-cursor"></span>');
                            } catch(e) {}
                        } else if (line.startsWith('event: error')) {
                            textContentDiv.innerHTML = "Ocorreu um erro no servidor.";
                        }
                    });
                    
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                    return reader.read().then(processText);
                 });
            }).catch(err => {
                console.error("Fetch error:", err);
                textContentDiv.innerHTML = "Erro de conexão ao enviar mensagem.";
                sendMessageButton.disabled = false;
            });
        };

        const updateHistoryUI = (activeId = null) => {
            document.querySelectorAll('#history-list a').forEach(a => {
                if (a.dataset.id == activeId) {
                    a.classList.add('active');
                } else {
                    a.classList.remove('active');
                }
            });
        };

        // --- EVENT LISTENERS ---
        newChatBtn.addEventListener('click', (e) => { e.preventDefault(); resetToWelcome(); });
        sendMessageButton.addEventListener('click', sendMessage);
        userMessageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }});
        
        profileButtons.forEach(button => {
            button.addEventListener('click', () => {
                profileButtons.forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                selectedProfile = button.dataset.profile;
                catechistOptions.style.display = selectedProfile === 'catequista' ? 'block' : 'none';
            });
        });

        document.querySelectorAll('.suggestion-pill').forEach(pill => {
            pill.addEventListener('click', () => {
                userMessageInput.value = pill.textContent;
                sendMessage();
            });
        });
        
        document.getElementById('theme-toggle-btn').addEventListener('click', (e) => {
            e.preventDefault();
            document.body.classList.toggle('light-mode');
            const isLight = document.body.classList.contains('light-mode');
            document.getElementById('theme-label').textContent = isLight ? "Mudar para Tema Escuro" : "Mudar para Tema Claro";
            document.querySelector('#theme-toggle-btn i').className = isLight ? "fas fa-moon" : "fas fa-sun";
        });
        
        document.getElementById('clear-history-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            if (confirm("Tem certeza que deseja apagar todo o histórico de conversas? Esta ação não pode ser desfeita.")) {
                await fetch('/api/conversation', { method: 'DELETE' });
                resetToWelcome();
                loadHistory();
            }
        });

        chatContainer.addEventListener('click', (e) => {
            if (e.target.matches('.fa-copy')) {
                const text = e.target.closest('.message-content').querySelector('.text-content').innerText;
                navigator.clipboard.writeText(text).then(() => alert("Texto copiado!"));
            }
        });

        const sidebar = document.getElementById('history-sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const menuOverlay = document.getElementById('menuOverlay');
        sidebarToggle.addEventListener('click', () => { sidebar.classList.add('open'); menuOverlay.classList.add('open'); });
        menuOverlay.addEventListener('click', () => { sidebar.classList.remove('open'); menuOverlay.classList.remove('open'); });

        loadHistory();
    });
    </script>
</body>
</html>